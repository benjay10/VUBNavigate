var Quiet=(function(){var sampleBufferSize=16384;var emscriptenInitialized=!1;var profilesFetched=!1;var profiles;var audioCtx;var readyCallbacks=[];var readyErrbacks=[];var failReason="";var gUM;var audioInput;var audioInputFailedReason="";var audioInputReadyCallbacks=[];var audioInputFailedCallbacks=[];var frameBufferSize=Math.pow(2,14);var receivers={};var receivers_idx=0;function isReady(){return emscriptenInitialized&&profilesFetched};function isFailed(){return failReason!==""};function start(){var len=readyCallbacks.length;for(var i=0;i<len;i++){readyCallbacks[i]()}};function initAudioContext(){if(audioCtx===undefined){audioCtx=new(window.AudioContext||window.webkitAudioContext)();console.log(audioCtx.sampleRate)}};function fail(reason){failReason=reason;var len=readyErrbacks.length;for(var i=0;i<len;i++){readyErrbacks[i](reason)}};function checkInitState(){if(isReady()){start()}};function onProfilesFetch(p){profiles=p;profilesFetched=!0;checkInitState()};function onEmscriptenInitialized(){emscriptenInitialized=!0;checkInitState()};function setProfilesPrefix(prefix){if(profilesFetched){return}
if(!prefix.endsWith("/")){prefix+="/"}
var profilesPath=prefix+"quiet-profiles.json";var fetch=new Promise(function(resolve,reject){var xhr=new XMLHttpRequest();xhr.overrideMimeType("application/json");xhr.open("GET",profilesPath,!0);xhr.onload=function(){if(this.status>=200&&this.status<300){resolve(this.responseText)}else{reject(this.statusText)}};xhr.onerror=function(){reject(this.statusText)};xhr.send()});fetch.then(function(body){onProfilesFetch(body)},function(err){fail("fetch of quiet-profiles.json failed: "+err)})};function setMemoryInitializerPrefix(prefix){Module.memoryInitializerPrefixURL=prefix};function setLibfecPrefix(prefix){Module.dynamicLibraries=Module.dynamicLibraries||[];Module.dynamicLibraries.push(prefix+"libfec.js")};function addReadyCallback(c,errback){if(isReady()){c();return}
readyCallbacks.push(c);if(errback!==undefined){if(isFailed()){errback(failReason);return}
readyErrbacks.push(errback)}};function init(opts){if(opts.profilesPrefix!==undefined){setProfilesPrefix(opts.profilesPrefix)}
if(opts.memoryInitializerPrefix!==undefined){setMemoryInitializerPrefix(opts.memoryInitializerPrefix)}
if(opts.libfecPrefix!==undefined){setLibfecPrefix(opts.libfecPrefix)}
if(opts.onReady!==undefined){if(opts.onError!==undefined){addReadyCallback(opts.onReady,opts.onError)}else{addReadyCallback(opts.onReady)}}};function transmitter(opts){var profile=opts.profile;var c_profiles,c_profile;if(typeof profile==='object'){c_profiles=Module.intArrayFromString(JSON.stringify({"profile":profile}));c_profile=Module.intArrayFromString("profile")}else{c_profiles=Module.intArrayFromString(profiles);c_profile=Module.intArrayFromString(profile)}
initAudioContext();var done=opts.onFinish;var opt=Module.ccall('quiet_encoder_profile_str','pointer',['array','array'],[c_profiles,c_profile]);var encoder=Module.ccall('quiet_encoder_create','pointer',['pointer','number'],[opt,audioCtx.sampleRate]);Module.ccall('free',null,['pointer'],[opt]);if(opts.clampFrame===undefined){opts.clampFrame=!0}
var frame_len;if(opts.clampFrame){frame_len=Module.ccall('quiet_encoder_clamp_frame_len','number',['pointer','number'],[encoder,sampleBufferSize])}else{frame_len=Module.ccall('quiet_encoder_get_frame_len','number',['pointer'],[encoder])}
var samples=Module.ccall('malloc','pointer',['number'],[4*sampleBufferSize]);var sample_view=Module.HEAPF32.subarray((samples/4),(samples/4)+sampleBufferSize);var dummy_osc;var running=!1;var transmitter;var destroyed=!1;var onaudioprocess=function(e){var output_l=e.outputBuffer.getChannelData(0);if(played===!0){for(var i=0;i<sampleBufferSize;i++){output_l[i]=0}
return}
played=!0;output_l.set(sample_view);window.setTimeout(writebuf,0)};var startTransmitter=function(){if(destroyed){return}
if(transmitter===undefined){var script_processor=(audioCtx.createScriptProcessor||audioCtx.createJavaScriptNode);transmitter=script_processor.call(audioCtx,sampleBufferSize,1,2);transmitter.onaudioprocess=onaudioprocess;dummy_osc=audioCtx.createOscillator();dummy_osc.type='square';dummy_osc.frequency.value=420}
dummy_osc.connect(transmitter);transmitter.connect(audioCtx.destination);running=!0};var stopTransmitter=function(){if(destroyed){return}
dummy_osc.disconnect();transmitter.disconnect();running=!1};var played=!0;var payload=[];var payloadView=new Uint8Array(payload);var empties_written=0;var last_emit_times=[];var num_emit_times=3;var writebuf=function(){if(destroyed){return}
var frame_available=!1;var frame_written=!1;while(!0){var frame=payload.shift();if(frame===undefined){break}
frame_available=!0;var written=Module.ccall('quiet_encoder_send','number',['pointer','array','number'],[encoder,new Uint8Array(frame),frame.byteLength]);if(written===-1){payload.unshift(frame);break}
frame_written=!0}
if(payload.length===0&&frame_written===!0){if(opts.onEnqueue!==undefined){window.setTimeout(opts.onEnqueue,0)}}
if(frame_available===!0&&running===!1){startTransmitter()}
if(played===!1){return}
var before=new Date();var written=Module.ccall('quiet_encoder_emit','number',['pointer','pointer','number'],[encoder,samples,sampleBufferSize]);var after=new Date();last_emit_times.unshift(after-before);if(last_emit_times.length>num_emit_times){last_emit_times.pop()}
if(frame_available===!1&&written===-1){if(empties_written<3){for(var i=0;i<sampleBufferSize;i++){sample_view[i]=0}
empties_written++;played=!1;return}
if(done!==undefined){done()}
if(running===!0){stopTransmitter()}
return}
played=!1;empties_written=0;if(written<sampleBufferSize){for(var i=written;i<sampleBufferSize;i++){sample_view[i]=0}}};var transmit=function(buf){if(destroyed){return}
for(var i=0;i<buf.byteLength;){var frame=buf.slice(i,i+frame_len);i+=frame.byteLength;payload.push(frame)}
writebuf()};var destroy=function(){if(destroyed){return}
Module.ccall('free',null,['pointer'],[samples]);Module.ccall('quiet_encoder_destroy',null,['pointer'],[encoder]);if(running===!0){stopTransmitter()}
destroyed=!0};var getAverageEncodeTime=function(){if(last_emit_times.length===0){return 0}
var total=0;for(var i=0;i<last_emit_times.length;i++){total+=last_emit_times[i]}
return total/(last_emit_times.length)};return{transmit:transmit,destroy:destroy,frameLength:frame_len,getAverageEncodeTime:getAverageEncodeTime}};function audioInputReady(){var len=audioInputReadyCallbacks.length;for(var i=0;i<len;i++){audioInputReadyCallbacks[i]()}};function audioInputFailed(reason){audioInputFailedReason=reason;var len=audioInputFailedCallbacks.length;for(var i=0;i<len;i++){audioInputFailedCallbacks[i](audioInputFailedReason)}};function addAudioInputReadyCallback(c,errback){if(errback!==undefined){if(audioInputFailedReason!==""){errback(audioInputFailedReason);return}
audioInputFailedCallbacks.push(errback)}
if(audioInput instanceof MediaStreamAudioSourceNode){c();return}
audioInputReadyCallbacks.push(c)}
function gUMConstraints(){if(navigator.webkitGetUserMedia!==undefined){return{audio:{optional:[{googAutoGainControl:!1},{googAutoGainControl2:!1},{echoCancellation:!1},{googEchoCancellation:!1},{googEchoCancellation2:!1},{googDAEchoCancellation:!1},{googNoiseSuppression:!1},{googNoiseSuppression2:!1},{googHighpassFilter:!1},{googTypingNoiseDetection:!1},{googAudioMirroring:!1}]}}}
if(navigator.mozGetUserMedia!==undefined){return{audio:{echoCancellation:!1,mozAutoGainControl:!1,mozNoiseSuppression:!1}}}
return{audio:{echoCancellation:!1}}};function createAudioInput(){audioInput=0;window.setTimeout(function(){gUM.call(navigator,gUMConstraints(),function(e){audioInput=audioCtx.createMediaStreamSource(e);window.quiet_receiver_anti_gc=audioInput;audioInputReady()},function(reason){audioInputFailed(reason.name)})},0)};function receiver(opts){var profile=opts.profile;var c_profiles,c_profile;if(typeof profile==='object'){c_profiles=Module.intArrayFromString(JSON.stringify({"profile":profile}));c_profile=Module.intArrayFromString("profile")}else{c_profiles=Module.intArrayFromString(profiles);c_profile=Module.intArrayFromString(profile)}
var opt=Module.ccall('quiet_decoder_profile_str','pointer',['array','array'],[c_profiles,c_profile]);initAudioContext();if(gUM===undefined){gUM=(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia)}
if(gUM===undefined){if(opts.onCreateFail!==undefined){opts.onCreateFail("getUserMedia undefined (mic not supported by browser)")}
return}
if(audioInput===undefined){createAudioInput()}
var scriptProcessor=audioCtx.createScriptProcessor(16384,2,1);var idx=receivers_idx;receivers[idx]=scriptProcessor;receivers_idx++;var decoder=Module.ccall('quiet_decoder_create','pointer',['pointer','number'],[opt,audioCtx.sampleRate]);Module.ccall('free',null,['pointer'],[opt]);var samples=Module.ccall('malloc','pointer',['number'],[4*sampleBufferSize]);var frame=Module.ccall('malloc','pointer',['number'],[frameBufferSize]);if(opts.onReceiverStatsUpdate!==undefined){Module.ccall('quiet_decoder_enable_stats',null,['pointer'],[decoder])}
var destroyed=!1;var readbuf=function(){if(destroyed){return}
while(!0){var read=Module.ccall('quiet_decoder_recv','number',['pointer','pointer','number'],[decoder,frame,frameBufferSize]);if(read===-1){break}
var frameArray=Module.HEAP8.slice(frame,frame+read);opts.onReceive(frameArray.buffer)}};var lastChecksumFailCount=0;var last_consume_times=[];var num_consume_times=3;var consume=function(){if(destroyed){return}
var before=new Date();Module.ccall('quiet_decoder_consume','number',['pointer','pointer','number'],[decoder,samples,sampleBufferSize]);var after=new Date();last_consume_times.unshift(after-before);if(last_consume_times.length>num_consume_times){last_consume_times.pop()}
window.setTimeout(readbuf,0);var currentChecksumFailCount=Module.ccall('quiet_decoder_checksum_fails','number',['pointer'],[decoder]);if((opts.onReceiveFail!==undefined)&&(currentChecksumFailCount>lastChecksumFailCount)){window.setTimeout(function(){opts.onReceiveFail(currentChecksumFailCount)},0)}
lastChecksumFailCount=currentChecksumFailCount;if(opts.onReceiverStatsUpdate!==undefined){var num_frames_ptr=Module.ccall('malloc','pointer',['number'],[4]);var frames=Module.ccall('quiet_decoder_consume_stats','pointer',['pointer','pointer'],[decoder,num_frames_ptr]);var num_frames=Module.HEAPU32[num_frames_ptr/4];Module.ccall('free',null,['pointer'],[num_frames_ptr]);var framesize=4+4+4+4+4;var stats=[];for(var i=0;i<num_frames;i++){var frameStats={};var frame=(frames+i*framesize)/4;var symbols=Module.HEAPU32[frame];var num_symbols=Module.HEAPU32[frame+1];frameStats.errorVectorMagnitude=Module.HEAPF32[frame+2];frameStats.receivedSignalStrengthIndicator=Module.HEAPF32[frame+3];frameStats.symbols=[];for(var j=0;j<num_symbols;j++){var symbol=(symbols+8*j)/4;frameStats.symbols.push({real:Module.HEAPF32[symbol],imag:Module.HEAPF32[symbol+1]})}
stats.push(frameStats)}
opts.onReceiverStatsUpdate(stats)}}
scriptProcessor.onaudioprocess=function(e){if(destroyed){return}
var input=e.inputBuffer.getChannelData(0);var sample_view=Module.HEAPF32.subarray(samples/4,samples/4+sampleBufferSize);sample_view.set(input);window.setTimeout(consume,0)}
addAudioInputReadyCallback(function(){audioInput.connect(scriptProcessor);if(opts.onCreate!==undefined){window.setTimeout(opts.onCreate,0)}},opts.onCreateFail);var fakeGain=audioCtx.createGain();fakeGain.value=0;scriptProcessor.connect(fakeGain);fakeGain.connect(audioCtx.destination);var destroy=function(){if(destroyed){return}
fakeGain.disconnect();scriptProcessor.disconnect();Module.ccall('free',null,['pointer'],[samples]);Module.ccall('free',null,['pointer'],[frame]);Module.ccall('quiet_decoder_destroy',null,['pointer'],[decoder]);delete receivers[idx];destroyed=!0};var getAverageDecodeTime=function(){if(last_consume_times.length===0){return 0}
var total=0;for(var i=0;i<last_consume_times.length;i++){total+=last_consume_times[i]}
return total/(last_consume_times.length)};return{destroy:destroy,getAverageDecodeTime:getAverageDecodeTime}};function str2ab(s){var s_utf8=unescape(encodeURIComponent(s));var buf=new ArrayBuffer(s_utf8.length);var bufView=new Uint8Array(buf);for(var i=0;i<s_utf8.length;i++){bufView[i]=s_utf8.charCodeAt(i)}
return buf};function ab2str(ab){return decodeURIComponent(escape(String.fromCharCode.apply(null,new Uint8Array(ab))))};function mergeab(ab1,ab2){var tmp=new Uint8Array(ab1.byteLength+ab2.byteLength);tmp.set(new Uint8Array(ab1),0);tmp.set(new Uint8Array(ab2),ab1.byteLength);return tmp.buffer};function disconnect(){if(audioInput!==undefined){audioInput.disconnect();audioInput=undefined;delete window.quiet_receiver_anti_gc}};return{emscriptenInitialized:onEmscriptenInitialized,addReadyCallback:addReadyCallback,init:init,transmitter:transmitter,receiver:receiver,str2ab:str2ab,ab2str:ab2str,mergeab:mergeab,disconnect:disconnect}})();var Module={onRuntimeInitialized:Quiet.emscriptenInitialized,memoryInitializerPrefixURL:""}
